#!/usr/bin/env node

// -*- js   -*-
// set -u -e -o pipefail

process.env.TEST_FILE = "0";

var _        = require('underscore');
var chokidar = require('chokidar');
var exec     = require("child_process").exec;
var spawn    = require("child_process").spawn;
var fs       = require("fs");
var path     = require("path");
var akui     = require('../app');
var term     = require('cli-color');

var throw_err= function (err) {
  throw err;
};

var shell    = function (cmd, func) {
  return exec(cmd, function (err, o, e) {
    if ( o ) process.stdout.write(o);
    if ( e ) process.stdout.write(e);
    if (err) throw err;
    if (func)
      func(o, e);
  });
};

var stop_stream = false;
function stream_results() {
  akui.stream_results(function (r, is_fin, stat) {

    if (stop_stream)
      return;

    if (r === 'timeout') {
      console.log('Akui: timed out.');
    } else {

      if (r.length) {
        _.each(r, function (pair) {
          var file = pair[0];
          var results = pair[1];
          var fail_color = (results.fail.length) ? "%r" : "%w";
          console.log(file, term.green("pass: " + results.pass.length), term.red("fail: " + results.fail.length));
        });
      }

      if (is_fin) {
        console.log(term.bold("Finished fetching results."));
        return;
      }
    }
  });
}

akui.clear_results(function () {
  stream_results();
});


// ****************************************************************
// ****************** Start watching... ***************************
// ****************************************************************

var watchers = [];
var watched_dirs  = [];
var server_started = false

function watch(dirs, func) {
  watched_dirs.push(dirs);
  var w = chokidar.watch(dirs,  {ignored: /^\./, persistent: true, interval: 190});
  watchers.push(w);
  return w;
}

watch("bin/watch")
.on('change', function (f) {
  console.log("\nFile bin/watch has changed. Exiting.");
  shutdown_all();
})
.on('error', throw_err);
;


watch( [path.resolve("./app.js") , "tests", 'public'] )
.on('add', function (f) {
  if (js_file(f))
    return;
  if (!server_started)
    return;
  console.log("\nadded: " + f);
  restart_server();
})
.on('change', function (filename) {
  if (js_file(filename))
    return;
  console.log("\nchanged: " + filename);
  restart_server();
})
.on('unlink', function (filename) {
  if (js_file(filename))
    return;
  console.log("\ndeleted: " + filename);
  restart_server();
})
.on('error', throw_err);
;


console.log("Watching: ", _.flatten(watched_dirs).join(', '), "\n");

function js_file(f) {
  if (f.indexOf('base.js') > -1 || f.indexOf('akui.js') > -1) {
    shell("bin/upgrade skip_download", function () {});
  }
  return f.indexOf('akui.js') > -1;
}


function shutdown_server(func) {
  exec('bin/stop', function (err, so, se) {
    if (so) console.log(so);
    if (se) console.log(se);
    if (err && !err.message.indexOf("no process found")) {
      console.log("Exiting because: " + err);
      process.exit(1);
    }
    func();
  });
}

function exec_this(cmd, func) {
  exec(cmd, function (err, so, se) {
    if (so) console.log(so);
    if (se) console.log(se);
    if (err && !err.message.match(/no process found/)) {
      console.log("Exiting because: " + err);
      process.exit(1);
    }
    func(so, se);
  });
}

function restart_server(func) {
  var server = spawn("bin/restart");
  server.stdout.on('data', function (raw_data) {
    var data = raw_data.toString();
    server_started = true;
    process.stdout.write(data);
  });

  server.stderr.on('data', function (data) {
    process.stdout.write("" + data);
  });

  server.on('close', function (code) {
    console.log('server closed: ' + code, "\n");
  });

  if (func)
    func();
}

function shutdown_all() {
  stop_stream = true;
  shutdown_server(function () {
    console.log('closing watchers...');
    close();
  });
}

function close() {
  var w = watchers.pop();
  if (w) {
    w.close();
    close();
  } else {
    akui.quit(function () {
      console.log('closing akui.');
    });
  }
}

process.on('SIGINT',  shutdown_all);
process.on('SIGTERM', shutdown_all);

restart_server();








